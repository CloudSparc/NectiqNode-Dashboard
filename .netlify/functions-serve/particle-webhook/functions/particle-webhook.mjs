
import {createRequire as ___nfyCreateRequire} from "module";
import {fileURLToPath as ___nfyFileURLToPath} from "url";
import {dirname as ___nfyPathDirname} from "path";
let __filename=___nfyFileURLToPath(import.meta.url);
let __dirname=___nfyPathDirname(___nfyFileURLToPath(import.meta.url));
let require=___nfyCreateRequire(import.meta.url);


// functions/utils/db.js
import pg from "pg";
var { Pool } = pg;
var connectionString = process.env.DATABASE_URL || process.env.NEON_DATABASE_URL;
if (!connectionString) {
  throw new Error("Missing DATABASE_URL (Neon Postgres connection string)");
}
var pool = new Pool({
  connectionString,
  ssl: { rejectUnauthorized: false }
});
async function query(q, params) {
  const client = await pool.connect();
  try {
    const res = await client.query(q, params);
    return res;
  } finally {
    client.release();
  }
}
async function ensureSchema() {
  await query(`
    CREATE TABLE IF NOT EXISTS devices (
      device_id TEXT PRIMARY KEY,
      name TEXT,
      created_at TIMESTAMPTZ DEFAULT NOW()
    );
  `);
  await query(`
    CREATE TABLE IF NOT EXISTS readings (
      id BIGSERIAL PRIMARY KEY,
      device_id TEXT NOT NULL REFERENCES devices(device_id) ON DELETE CASCADE,
      ts TIMESTAMPTZ NOT NULL,
      temp_c DOUBLE PRECISION,
      humidity DOUBLE PRECISION,
      sound_db DOUBLE PRECISION,
      payload_json JSONB
    );
  `);
}

// functions/particle-webhook.js
var particle_webhook_default = async (req, context) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: cors() });
  }
  if (req.method !== "POST") {
    return json({ error: "Method not allowed" }, 405);
  }
  const secret = req.headers.get("x-webhook-secret");
  if (!secret || secret !== (process.env.WEBHOOK_SECRET || "change-me")) {
    return json({ error: "unauthorized" }, 401);
  }
  let payload;
  try {
    payload = await req.json();
  } catch {
    return json({ error: "invalid json" }, 400);
  }
  const device_id = payload.device_id || payload.coreid || "unknown";
  const published_at = payload.published_at;
  const data = payload.data;
  let parsed = {};
  if (typeof data === "string") {
    try {
      parsed = JSON.parse(data);
    } catch {
      const parts = data.split(",").map((p) => p.trim());
      if (parts.length >= 3)
        parsed = { t: parseFloat(parts[0]), h: parseFloat(parts[1]), s: parseFloat(parts[2]) };
    }
  } else if (data && typeof data === "object") {
    parsed = data;
  }
  const t = coalesce(parsed.t, parsed.temp, parsed.temperature);
  const h = coalesce(parsed.h, parsed.hum, parsed.humidity);
  const s = coalesce(parsed.s, parsed.sound, parsed.sound_db);
  let ts;
  try {
    ts = published_at ? new Date(published_at).toISOString() : (/* @__PURE__ */ new Date()).toISOString();
  } catch {
    ts = (/* @__PURE__ */ new Date()).toISOString();
  }
  try {
    await ensureSchema();
    await query(`
      INSERT INTO devices (device_id, name)
      VALUES ($1, $1)
      ON CONFLICT (device_id) DO NOTHING
    `, [device_id]);
    await query(`
      INSERT INTO readings (device_id, ts, temp_c, humidity, sound_db, payload_json)
      VALUES ($1, $2, $3, $4, $5, $6::jsonb)
    `, [device_id, ts, t, h, s, JSON.stringify(payload)]);
  } catch (e) {
    return json({ error: "db error", details: e.message }, 500);
  }
  return json({ status: "ok" });
};
function coalesce(...vals) {
  for (const v of vals)
    if (v !== void 0 && v !== null)
      return v;
  return null;
}
function cors() {
  return {
    "Access-Control-Allow-Origin": process.env.CORS_ORIGINS || "*",
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, X-Webhook-Secret"
  };
}
function json(body, status = 200) {
  return new Response(JSON.stringify(body), { status, headers: { ...cors(), "Content-Type": "application/json" } });
}
export {
  particle_webhook_default as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiZnVuY3Rpb25zL3V0aWxzL2RiLmpzIiwgImZ1bmN0aW9ucy9wYXJ0aWNsZS13ZWJob29rLmpzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvLyBmdW5jdGlvbnMvdXRpbHMvZGIuanNcbmltcG9ydCBwZyBmcm9tICdwZyc7XG5jb25zdCB7IFBvb2wgfSA9IHBnO1xuXG5jb25zdCBjb25uZWN0aW9uU3RyaW5nID0gcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMIHx8IHByb2Nlc3MuZW52Lk5FT05fREFUQUJBU0VfVVJMO1xuaWYgKCFjb25uZWN0aW9uU3RyaW5nKSB7XG4gIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBEQVRBQkFTRV9VUkwgKE5lb24gUG9zdGdyZXMgY29ubmVjdGlvbiBzdHJpbmcpJyk7XG59XG5cbi8vIE5lb24gcmVxdWlyZXMgU1NMIGluIG1vc3QgY2FzZXNcbmNvbnN0IHBvb2wgPSBuZXcgUG9vbCh7XG4gIGNvbm5lY3Rpb25TdHJpbmcsXG4gIHNzbDogeyByZWplY3RVbmF1dGhvcml6ZWQ6IGZhbHNlIH1cbn0pO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcXVlcnkocSwgcGFyYW1zKSB7XG4gIGNvbnN0IGNsaWVudCA9IGF3YWl0IHBvb2wuY29ubmVjdCgpO1xuICB0cnkge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IGNsaWVudC5xdWVyeShxLCBwYXJhbXMpO1xuICAgIHJldHVybiByZXM7XG4gIH0gZmluYWxseSB7XG4gICAgY2xpZW50LnJlbGVhc2UoKTtcbiAgfVxufVxuXG4vLyBFbnN1cmUgdGFibGVzIGV4aXN0IChydW4gYXQgY29sZCBzdGFydClcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBlbnN1cmVTY2hlbWEoKSB7XG4gIGF3YWl0IHF1ZXJ5KGBcbiAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBkZXZpY2VzIChcbiAgICAgIGRldmljZV9pZCBURVhUIFBSSU1BUlkgS0VZLFxuICAgICAgbmFtZSBURVhULFxuICAgICAgY3JlYXRlZF9hdCBUSU1FU1RBTVBUWiBERUZBVUxUIE5PVygpXG4gICAgKTtcbiAgYCk7XG4gIGF3YWl0IHF1ZXJ5KGBcbiAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyByZWFkaW5ncyAoXG4gICAgICBpZCBCSUdTRVJJQUwgUFJJTUFSWSBLRVksXG4gICAgICBkZXZpY2VfaWQgVEVYVCBOT1QgTlVMTCBSRUZFUkVOQ0VTIGRldmljZXMoZGV2aWNlX2lkKSBPTiBERUxFVEUgQ0FTQ0FERSxcbiAgICAgIHRzIFRJTUVTVEFNUFRaIE5PVCBOVUxMLFxuICAgICAgdGVtcF9jIERPVUJMRSBQUkVDSVNJT04sXG4gICAgICBodW1pZGl0eSBET1VCTEUgUFJFQ0lTSU9OLFxuICAgICAgc291bmRfZGIgRE9VQkxFIFBSRUNJU0lPTixcbiAgICAgIHBheWxvYWRfanNvbiBKU09OQlxuICAgICk7XG4gIGApO1xufVxuIiwgIi8vIGZ1bmN0aW9ucy9wYXJ0aWNsZS13ZWJob29rLmpzXG5pbXBvcnQgeyBxdWVyeSwgZW5zdXJlU2NoZW1hIH0gZnJvbSAnLi91dGlscy9kYi5qcyc7XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIChyZXEsIGNvbnRleHQpID0+IHtcbiAgaWYgKHJlcS5tZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgIHJldHVybiBuZXcgUmVzcG9uc2UobnVsbCwgeyBoZWFkZXJzOiBjb3JzKCkgfSk7XG4gIH1cbiAgaWYgKHJlcS5tZXRob2QgIT09ICdQT1NUJykge1xuICAgIHJldHVybiBqc29uKHsgZXJyb3I6ICdNZXRob2Qgbm90IGFsbG93ZWQnIH0sIDQwNSk7XG4gIH1cblxuICBjb25zdCBzZWNyZXQgPSByZXEuaGVhZGVycy5nZXQoJ3gtd2ViaG9vay1zZWNyZXQnKTtcbiAgaWYgKCFzZWNyZXQgfHwgc2VjcmV0ICE9PSAocHJvY2Vzcy5lbnYuV0VCSE9PS19TRUNSRVQgfHwgJ2NoYW5nZS1tZScpKSB7XG4gICAgcmV0dXJuIGpzb24oeyBlcnJvcjogJ3VuYXV0aG9yaXplZCcgfSwgNDAxKTtcbiAgfVxuXG4gIGxldCBwYXlsb2FkO1xuICB0cnkgeyBwYXlsb2FkID0gYXdhaXQgcmVxLmpzb24oKTsgfVxuICBjYXRjaCB7IHJldHVybiBqc29uKHsgZXJyb3I6ICdpbnZhbGlkIGpzb24nIH0sIDQwMCk7IH1cblxuICBjb25zdCBkZXZpY2VfaWQgPSBwYXlsb2FkLmRldmljZV9pZCB8fCBwYXlsb2FkLmNvcmVpZCB8fCAndW5rbm93bic7XG4gIGNvbnN0IHB1Ymxpc2hlZF9hdCA9IHBheWxvYWQucHVibGlzaGVkX2F0O1xuICBjb25zdCBkYXRhID0gcGF5bG9hZC5kYXRhO1xuXG4gIC8vIHBhcnNlIGRhdGFcbiAgbGV0IHBhcnNlZCA9IHt9O1xuICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgdHJ5IHsgcGFyc2VkID0gSlNPTi5wYXJzZShkYXRhKTsgfVxuICAgIGNhdGNoIHtcbiAgICAgIGNvbnN0IHBhcnRzID0gZGF0YS5zcGxpdCgnLCcpLm1hcChwID0+IHAudHJpbSgpKTtcbiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPj0gMykgcGFyc2VkID0geyB0OiBwYXJzZUZsb2F0KHBhcnRzWzBdKSwgaDogcGFyc2VGbG9hdChwYXJ0c1sxXSksIHM6IHBhcnNlRmxvYXQocGFydHNbMl0pIH07XG4gICAgfVxuICB9IGVsc2UgaWYgKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgcGFyc2VkID0gZGF0YTtcbiAgfVxuXG4gIGNvbnN0IHQgPSBjb2FsZXNjZShwYXJzZWQudCwgcGFyc2VkLnRlbXAsIHBhcnNlZC50ZW1wZXJhdHVyZSk7XG4gIGNvbnN0IGggPSBjb2FsZXNjZShwYXJzZWQuaCwgcGFyc2VkLmh1bSwgcGFyc2VkLmh1bWlkaXR5KTtcbiAgY29uc3QgcyA9IGNvYWxlc2NlKHBhcnNlZC5zLCBwYXJzZWQuc291bmQsIHBhcnNlZC5zb3VuZF9kYik7XG5cbiAgbGV0IHRzO1xuICB0cnkgeyB0cyA9IHB1Ymxpc2hlZF9hdCA/IG5ldyBEYXRlKHB1Ymxpc2hlZF9hdCkudG9JU09TdHJpbmcoKSA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsgfVxuICBjYXRjaCB7IHRzID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOyB9XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBlbnN1cmVTY2hlbWEoKTtcbiAgICBhd2FpdCBxdWVyeShgXG4gICAgICBJTlNFUlQgSU5UTyBkZXZpY2VzIChkZXZpY2VfaWQsIG5hbWUpXG4gICAgICBWQUxVRVMgKCQxLCAkMSlcbiAgICAgIE9OIENPTkZMSUNUIChkZXZpY2VfaWQpIERPIE5PVEhJTkdcbiAgICBgLCBbZGV2aWNlX2lkXSk7XG5cbiAgICBhd2FpdCBxdWVyeShgXG4gICAgICBJTlNFUlQgSU5UTyByZWFkaW5ncyAoZGV2aWNlX2lkLCB0cywgdGVtcF9jLCBodW1pZGl0eSwgc291bmRfZGIsIHBheWxvYWRfanNvbilcbiAgICAgIFZBTFVFUyAoJDEsICQyLCAkMywgJDQsICQ1LCAkNjo6anNvbmIpXG4gICAgYCwgW2RldmljZV9pZCwgdHMsIHQsIGgsIHMsIEpTT04uc3RyaW5naWZ5KHBheWxvYWQpXSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4ganNvbih7IGVycm9yOiAnZGIgZXJyb3InLCBkZXRhaWxzOiBlLm1lc3NhZ2UgfSwgNTAwKTtcbiAgfVxuXG4gIHJldHVybiBqc29uKHsgc3RhdHVzOiAnb2snIH0pO1xufTtcblxuZnVuY3Rpb24gY29hbGVzY2UoLi4udmFscykge1xuICBmb3IgKGNvbnN0IHYgb2YgdmFscykgaWYgKHYgIT09IHVuZGVmaW5lZCAmJiB2ICE9PSBudWxsKSByZXR1cm4gdjtcbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGNvcnMoKSB7XG4gIHJldHVybiB7XG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6IHByb2Nlc3MuZW52LkNPUlNfT1JJR0lOUyB8fCAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnR0VULFBPU1QsT1BUSU9OUycsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLCBYLVdlYmhvb2stU2VjcmV0J1xuICB9O1xufVxuXG5mdW5jdGlvbiBqc29uKGJvZHksIHN0YXR1cz0yMDApIHtcbiAgcmV0dXJuIG5ldyBSZXNwb25zZShKU09OLnN0cmluZ2lmeShib2R5KSwgeyBzdGF0dXMsIGhlYWRlcnM6IHsgLi4uY29ycygpLCAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0gfSk7XG59XG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7O0FBQ0EsT0FBTyxRQUFRO0FBQ2YsSUFBTSxFQUFFLEtBQUssSUFBSTtBQUVqQixJQUFNLG1CQUFtQixRQUFRLElBQUksZ0JBQWdCLFFBQVEsSUFBSTtBQUNqRSxJQUFJLENBQUMsa0JBQWtCO0FBQ3JCLFFBQU0sSUFBSSxNQUFNLHdEQUF3RDtBQUMxRTtBQUdBLElBQU0sT0FBTyxJQUFJLEtBQUs7QUFBQSxFQUNwQjtBQUFBLEVBQ0EsS0FBSyxFQUFFLG9CQUFvQixNQUFNO0FBQ25DLENBQUM7QUFFRCxlQUFzQixNQUFNLEdBQUcsUUFBUTtBQUNyQyxRQUFNLFNBQVMsTUFBTSxLQUFLLFFBQVE7QUFDbEMsTUFBSTtBQUNGLFVBQU0sTUFBTSxNQUFNLE9BQU8sTUFBTSxHQUFHLE1BQU07QUFDeEMsV0FBTztBQUFBLEVBQ1QsVUFBRTtBQUNBLFdBQU8sUUFBUTtBQUFBLEVBQ2pCO0FBQ0Y7QUFHQSxlQUFzQixlQUFlO0FBQ25DLFFBQU0sTUFBTTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxHQU1YO0FBQ0QsUUFBTSxNQUFNO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsR0FVWDtBQUNIOzs7QUMxQ0EsSUFBTywyQkFBUSxPQUFPLEtBQUssWUFBWTtBQUNyQyxNQUFJLElBQUksV0FBVyxXQUFXO0FBQzVCLFdBQU8sSUFBSSxT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
