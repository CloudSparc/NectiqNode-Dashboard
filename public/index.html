<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NectiqNode Monitor</title>

  <!-- Fonts & styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- Netlify Identity (load once) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    /* ------------------ 1) Helpers defined first ------------------ */
    window.$ = (s) => document.querySelector(s);

    window.refreshAuthUI = function refreshAuthUI() {
      const idw = window.netlifyIdentity;
      if (!idw) return;
      const u = idw.currentUser();
      const login  = document.getElementById('btnLogin');
      const logout = document.getElementById('btnLogout');
      const whoami = document.getElementById('whoami');
      if (!login || !logout || !whoami) return;
      login.style.display  = u ? 'none' : '';
      logout.style.display = u ? '' : 'none';
      whoami.textContent   = u ? `Signed in as ${u.email}` : '';
    };

    // Attach JWT when available
    window.authFetch = async function authFetch(url, opts = {}) {
      const idw = window.netlifyIdentity;
      const u = idw ? idw.currentUser() : null;
      if (u) {
        const token = await u.jwt();
        opts.headers = { ...(opts.headers || {}), Authorization: `Bearer ${token}` };
      }
      return fetch(url, opts);
    };

    /* ------------- 2) Identity wiring (init deferred) ------------- */
    (function waitForIdentity(cb){
      if (window.netlifyIdentity) return cb(window.netlifyIdentity);
      setTimeout(() => waitForIdentity(cb), 50);
    })(function(idw){
      if (!idw.__nectiqWired) {
        // Fires once after init
        idw.on('init', (user) => {
          refreshAuthUI();
          // If already logged in, populate data now (prevents 401)
          if (user && typeof window.loadDevices === 'function') {
            window.loadDevices();
          }
        });

        idw.on('login', async () => {
          refreshAuthUI();
          // Clean up the hash like "#access_token=..." or "/#"
          if (location.hash) {
            history.replaceState(null, '', location.pathname + location.search);
          }
          try { idw.close(); } catch {}
          if (typeof window.loadDevices === 'function') {
            await window.loadDevices();
          }
        });

        idw.on('logout', () => {
          refreshAuthUI();
          if (location.hash) {
            history.replaceState(null, '', location.pathname + location.search);
          }
          // Clear UI
          const sel = document.getElementById('deviceSelect');
          if (sel) sel.innerHTML = '';
          const pv = document.getElementById('devicePreview');
          if (pv) pv.textContent = '';
          // (Charts remain but will show no new points until login)
        });

        idw.__nectiqWired = true;
      }

      // Defer init until DOM exists to avoid appendChild(null)
      const start = () => idw.init();
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', start, { once: true });
      } else {
        start();
      }

      async function refreshDevices() {
  try {
    const res = await apiFetch("/api/devices");
    const select = document.getElementById("deviceSelect");
    select.innerHTML = "";
    (res.devices || []).forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.device_id;
      opt.textContent = d.name;
      select.appendChild(opt);
    });
  } catch (e) {
    console.error(e);
  }
}

    });
  </script>
  <script>
  async function getToken() {
    // Using Netlify Identity widget (gotrue). Ensure widget is initialized on your page.
    // window.netlifyIdentity must be available.
    const user = window.netlifyIdentity?.currentUser();
    if (!user) return null;
    return await user.jwt();
  }

  export async function apiFetch(path, options = {}) {
    const token = await getToken();
    const headers = { ...(options.headers || {}), "Content-Type": "application/json" };
    if (token) headers.Authorization = `Bearer ${token}`;
    const res = await fetch(path, { ...options, headers });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return res.json();
  }

  // Example usage:
  // apiFetch("/api/whoami").then(console.log).catch(console.error);
</script>

</head>

<body>
  <header style="display:flex;justify-content:center;align-items:center;gap:16px;margin:16px 0;">
    <div><img src="logo.png" alt="" style="width:50px;height:50px;object-fit:contain;border-radius:25px;zoom:1.8;" /></div>
    <div class="brand">NectiqNode Monitor</div>
  </header>

  <div id="authBar" style="display:flex;gap:8px;align-items:center;margin:8px 0;justify-content:flex-end;">
    <button id="btnLogin"  style="padding:5px 10px;border:none;border-radius:4px;background:#E0C051;color:#212529;cursor:pointer">Log in</button>
    <button id="btnLogout" style="display:none;padding:5px 10px;border:none;border-radius:4px;background:#E0C051;color:#212529;cursor:pointer">Log out</button>
    <span id="whoami" class="muted"></span>
  </div>

  <main>
    <div class="row">
      <div class="card">
        <h3 style="margin-top:0">Devices</h3>
        <select style="width: 200px; padding: 8px; border: 1px solid #3c3939; border-radius: 4px;" id="deviceSelect"></select>
        <div style="margin-top:12px">
          <button id="refreshBtn">Reload devices</button>
        </div>
        <div id="devicePreview" style="margin-top:8px; font-size:13px; color:#4EA6E1;"></div>
        <p class="muted" style="margin-top:12px; font-size: 9.5px;">
          Your Particle webhook: <code>https://nectiqdashboard.netlify.app/api/particle-webhook</code>
        </p>
      </div>

      <div class="grid">
        <div class="card">
          <div class="stats">
            <div class="stat"><div class="muted">Temperature (°C)</div><div id="statTemp" style="font-size:1.6rem;font-weight:800">--</div></div>
            <div class="stat"><div class="muted">Humidity (%)</div><div id="statHum" style="font-size:1.6rem;font-weight:800">--</div></div>
            <div class="stat"><div class="muted">Sound (dB)</div><div id="statSound" style="font-size:1.6rem;font-weight:800">--</div></div>
          </div>
        </div>
        <div class="card"><canvas id="tempChart" height="110"></canvas></div>
        <div class="card"><canvas id="humChart" height="110"></canvas></div>
        <div class="card"><canvas id="soundChart" height="110"></canvas></div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const idw = window.netlifyIdentity;
      const API_BASE = '/api';

      // Buttons
      const lb = document.getElementById('btnLogin');  if (lb && idw) lb.addEventListener('click', () => idw.open('login'));
      const lo = document.getElementById('btnLogout'); if (lo && idw) lo.addEventListener('click', () => idw.logout());
      const deviceSelect = document.getElementById('deviceSelect');
      const devicePreview = document.getElementById('devicePreview');

      /* ---------- Charts setup ---------- */
      const COLOR_TEMP = '#E14E5D'; // red
      const COLOR_HUM  = '#4EA6E1'; // blue
      const COLOR_SND  = '#E1D24E'; // yellow
      let tempChart, humChart, soundChart;

      function fmtTs(ts) { return new Date(ts).toLocaleTimeString(); }

      function newLineChart(ctx, label, { color, pointStyle }) {
        return new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [{
            label, data: [], tension: 0.25, fill: false,
            borderColor: color, backgroundColor: color, borderWidth: 2, pointStyle,
            pointRadius: (c) => ((c.chart?.data?.labels?.length || 0) < 2 ? 5 : 0),
            pointHoverRadius: 5, spanGaps: true
          }]},
          options: {
            responsive: true, animation: false,
            scales: { x: { ticks: { color: '#9aa3b2' } },
                      y: { ticks: { color: '#9aa3b2' } } },
            plugins: {
              legend: {
                labels: {
                  color: '#e6e6e6', usePointStyle: true, boxWidth: 16, boxHeight: 16, padding: 18,
                  font: { family: 'monospace', size: 12 },
                  generateLabels: (chart) => {
                    const base = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                    const maxLen = Math.max(...base.map(l => l.text.length));
                    return base.map(l => ({ ...l, text: l.text.padEnd(maxLen, ' ') }));
                  }
                }
              }
            }
          }
        });
      }

      tempChart  = newLineChart(document.getElementById('tempChart'),  'Temperature (°C)', { color: COLOR_TEMP, pointStyle: 'circle' });
      humChart   = newLineChart(document.getElementById('humChart'),   'Humidity (%)',     { color: COLOR_HUM,  pointStyle: 'circle' });
      soundChart = newLineChart(document.getElementById('soundChart'), 'Sound (dB)',       { color: COLOR_SND,  pointStyle: 'circle' });

      function pushPoint(chart, x, y, max = 200) {
        chart.data.labels.push(x);
        chart.data.datasets[0].data.push(y);
        if (chart.data.labels.length > max) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }
        chart.update('none');
      }

      /* ---------- Data loaders ---------- */
      window.loadDevices = async function loadDevices() {
        const res = await authFetch(`${API_BASE}/devices`);
        if (!res.ok) { console.warn('devices HTTP', res.status); return; }
        const data = await res.json();

        deviceSelect.innerHTML = '';
        (data.devices || []).forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.device_id;
          opt.textContent = d.name || d.device_id;
          deviceSelect.appendChild(opt);
        });

        if (data.devices?.length) {
          deviceSelect.value = data.devices[0].device_id;
          await loadHistory(deviceSelect.value);
          const selOpt = deviceSelect.options[deviceSelect.selectedIndex];
          devicePreview.textContent = selOpt ? `Selected device: ${selOpt.textContent}` : '';
        }
      };

      async function loadHistory(device_id) {
        const res = await authFetch(`${API_BASE}/readings?device_id=${encodeURIComponent(device_id)}&limit=200`);
        if (!res.ok) { console.warn('readings HTTP', res.status); return; }
        const data = await res.json();

        // reset
        [tempChart, humChart, soundChart].forEach(c => { c.data.labels = []; c.data.datasets[0].data = []; c.update('none'); });

        (data.readings || []).forEach(r => {
          if (r.temp_c   != null) pushPoint(tempChart,  fmtTs(r.ts), r.temp_c);
          if (r.humidity != null) pushPoint(humChart,   fmtTs(r.ts), r.humidity);
          if (r.sound_db != null) pushPoint(soundChart, fmtTs(r.ts), r.sound_db);
        });

        if (data.readings?.length) {
          const last = data.readings[data.readings.length - 1];
          document.getElementById('statTemp').textContent  = (last.temp_c   != null) ? last.temp_c.toFixed(1)  : '--';
          document.getElementById('statHum').textContent   = (last.humidity != null) ? last.humidity.toFixed(1): '--';
          document.getElementById('statSound').textContent = (last.sound_db != null) ? last.sound_db.toFixed(0): '--';
        }
      }

      deviceSelect.addEventListener('change', (e) => {
        loadHistory(e.target.value);
        const selOpt = deviceSelect.options[deviceSelect.selectedIndex];
        devicePreview.textContent = selOpt ? `Selected device: ${selOpt.textContent}` : '';
      });

      document.getElementById('refreshBtn').addEventListener('click', () => {
        const u = idw?.currentUser?.();
        if (u) loadDevices(); // only if logged in
      });

      // DO NOT call loadDevices() here; Identity handlers will call it when a user exists.
    });
  </script>
</body>
</html>
